name: Build, Test and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: eu-central-1
  AWS_ACCOUNT_ID: 824912998004
  ECR_REPOSITORY: picus-flask-app
  ECS_SERVICE: picus-flask-service
  ECS_CLUSTER: picus-cluster
  ECS_TASK_DEFINITION: picus-task-definition
  CONTAINER_NAME: picus-flask-app
  LAMBDA_ROLE_ARN: arn:aws:iam::824912998004:role/picus-lambda-role

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Python availability
      run: |
        python3 --version || echo "Python3 not found"
        which python3 || echo "python3 not in PATH"
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"
    
    - name: Verify Python installation
      run: |
        python --version
        which python
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo "Installing requirements..."
        pip install -r requirements.txt || echo "Failed to install requirements"
        echo "Installing pytest..."
        pip install pytest pytest-cov || echo "Failed to install pytest"
        echo "Verifying installations..."
        pip list | grep -E "(Flask|boto3|gunicorn|pytest)"
    
    - name: Run tests
      run: |
        echo "Running tests..."
        echo "Python version: $(python --version)"
        echo "Working directory: $(pwd)"
        echo "Files in directory:"
        ls -la
        echo "Running test_app.py..."
        python test_app.py
      env:
        DYNAMODB_TABLE_NAME: picus_data
        AWS_DEFAULT_REGION: eu-central-1

  build-and-deploy:
    name: Build Docker Image and Deploy
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1
    
    - name: Build, tag, and push image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Build Docker image (GitHub Actions runner is already linux/amd64)
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
        # Push image to ECR
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT
    
    - name: Fill in the new image ID in the Amazon ECS task definition
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: ecs-task-definition.json
        container-name: ${{ env.CONTAINER_NAME }}
        image: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:latest
    
    - name: Deploy Amazon ECS task definition
      uses: aws-actions/amazon-ecs-deploy-task-definition@v1
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: ${{ env.ECS_SERVICE }}
        cluster: ${{ env.ECS_CLUSTER }}
        wait-for-service-stability: true
        wait-for-minutes: 10

  deploy-lambda:
    name: Deploy Lambda Function
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Install dependencies and create package
      run: |
        pip install boto3 -t .
        zip -r lambda-function.zip handler.py boto3* botocore* -x "*.pyc" -x "*__pycache__*"
    
    - name: Deploy Lambda function
      run: |
        FUNCTION_NAME="picus-delete-function"
        if aws lambda get-function --function-name $FUNCTION_NAME --region ${{ env.AWS_REGION }} 2>/dev/null; then
          aws lambda update-function-code --function-name $FUNCTION_NAME \
            --zip-file fileb://lambda-function.zip --region ${{ env.AWS_REGION }}
        else
          aws lambda create-function --function-name $FUNCTION_NAME \
            --runtime python3.10 --role "${{ env.LAMBDA_ROLE_ARN }}" \
            --handler handler.delete_item --zip-file fileb://lambda-function.zip \
            --timeout 30 --memory-size 256 \
            --environment "Variables={DYNAMODB_TABLE_NAME=picus_data}" \
            --architecture x86_64 --region ${{ env.AWS_REGION }}
        fi

